using Microsoft.AspNetCore.Builder; using Microsoft.AspNetCore.Diagnostics.HealthChecks; using Microsoft.Extensions.DependencyInjection; using Microsoft.Extensions.Diagnostics.HealthChecks; using Microsoft.Extensions.Http.Resilience; using Microsoft.Extensions.Logging; using OpenTelemetry; using OpenTelemetry.Metrics; using OpenTelemetry.Trace;  namespace Microsoft.Extensions.Hosting;  public static class Extensions {     public static IHostApplicationBuilder AddServiceDefaults(this IHostApplicationBuilder builder)     {         builder.ConfigureOpenTelemetry();         builder.AddDefaultHealthChecks();         builder.Services.AddServiceDiscovery();         builder.Services.ConfigureHttpClientDefaults(http =>         {             // Configure resilience with extended timeouts for LLM and agent calls             http.AddStandardResilienceHandler(options =>             {                 // LLM calls and agent calls can take 30+ seconds                 options.AttemptTimeout.Timeout = TimeSpan.FromMinutes(2);                 options.TotalRequestTimeout.Timeout = TimeSpan.FromMinutes(5);                 // Circuit breaker sampling duration must be at least double the attempt timeout                 options.CircuitBreaker.SamplingDuration = TimeSpan.FromMinutes(5);             });             http.AddServiceDiscovery();         });          return builder;     }      public static IHostApplicationBuilder ConfigureOpenTelemetry(this IHostApplicationBuilder builder)     {         builder.Logging.AddOpenTelemetry(logging =>         {             logging.IncludeFormattedMessage = true;             logging.IncludeScopes = true;         });          builder.Services.AddOpenTelemetry()             .WithMetrics(metrics =>             {                 metrics.AddAspNetCoreInstrumentation()                     .AddHttpClientInstrumentation()                     .AddRuntimeInstrumentation();             })             .WithTracing(tracing =>             {                 tracing.AddSource(builder.Environment.ApplicationName)                     .AddAspNetCoreInstrumentation()                     .AddHttpClientInstrumentation();             });          builder.AddOpenTelemetryExporters();          return builder;     }      private static IHostApplicationBuilder AddOpenTelemetryExporters(this IHostApplicationBuilder builder)     {         var useOtlpExporter = !string.IsNullOrWhiteSpace(builder.Configuration["OTEL_EXPORTER_OTLP_ENDPOINT"]);          if (useOtlpExporter)         {             builder.Services.AddOpenTelemetry().UseOtlpExporter();         }          return builder;     }      public static IHostApplicationBuilder AddDefaultHealthChecks(this IHostApplicationBuilder builder)     {         builder.Services.AddHealthChecks()             // Add a default liveness check to ensure the app is responsive             .AddCheck("self", () => HealthCheckResult.Healthy(), ["live"])             // Add a ready check that Aspire will wait for before starting dependent services             .AddCheck("ready", () => HealthCheckResult.Healthy(), ["ready"]);          return builder;     }      public static WebApplication MapDefaultEndpoints(this WebApplication app)     {         // Health check endpoints for Aspire orchestration         // /health - all health checks (used by Aspire to determine service readiness)         app.MapHealthChecks("/health");          // /alive - liveness check (is the app running and responsive?)         app.MapHealthChecks("/alive", new HealthCheckOptions         {             Predicate = r => r.Tags.Contains("live")         });          // /ready - readiness check (is the app ready to accept traffic?)         app.MapHealthChecks("/ready", new HealthCheckOptions         {             Predicate = r => r.Tags.Contains("ready")         });          return app;     } }  