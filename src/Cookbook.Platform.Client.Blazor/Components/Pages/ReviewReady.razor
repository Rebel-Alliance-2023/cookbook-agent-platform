@page "/ingest/review/{TaskId}"
@using global::Cookbook.Platform.Client.Blazor.Components.Shared
@rendermode InteractiveServer

<PageTitle>Review Imported Recipe</PageTitle>

<header class="qg-page-header">
    <h1 class="qg-page-title">Review Recipe</h1>
    <p class="qg-page-subtitle">
        Review the extracted recipe before adding it to your cookbook
    </p>
</header>

@if (isLoading)
{
    <div class="loading-container">
        <div class="loading-spinner large"></div>
        <p>Loading recipe draft...</p>
    </div>
}
else if (errorMessage != null)
{
    <div class="qg-card error-card">
        <div class="error-content">
            <h3>Error Loading Recipe</h3>
            <p>@errorMessage</p>
            <button class="qg-btn qg-btn-primary" @onclick="NavigateToIngest">
                Try Another URL
            </button>
        </div>
    </div>
}
else if (draft != null)
{
    <div class="review-layout">
        <!-- Recipe Details -->
        <div class="qg-card recipe-card">
            <div class="recipe-header">
                @if (!string.IsNullOrEmpty(draft.Recipe.ImageUrl))
                {
                    <img src="@draft.Recipe.ImageUrl" alt="@draft.Recipe.Name" class="recipe-image" />
                }
                <div class="recipe-title-section">
                    <h2 class="recipe-title">@draft.Recipe.Name</h2>
                    @if (!string.IsNullOrEmpty(draft.Recipe.Description))
                    {
                        <p class="recipe-description">@draft.Recipe.Description</p>
                    }
                </div>
            </div>

            <div class="recipe-meta">
                <div class="meta-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span>Prep: @FormatTime(draft.Recipe.PrepTimeMinutes)</span>
                </div>
                <div class="meta-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                    </svg>
                    <span>Cook: @FormatTime(draft.Recipe.CookTimeMinutes)</span>
                </div>
                <div class="meta-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>Servings: @draft.Recipe.Servings</span>
                </div>
                @if (!string.IsNullOrEmpty(draft.Recipe.Cuisine))
                {
                    <div class="meta-item">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="2" y1="12" x2="22" y2="12"/>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        </svg>
                        <span>@draft.Recipe.Cuisine</span>
                    </div>
                }
            </div>

            @if (draft.Recipe.Tags.Any())
            {
                <div class="recipe-tags">
                    @foreach (var tag in draft.Recipe.Tags)
                    {
                        <span class="tag">@tag</span>
                    }
                </div>
            }

            <!-- Ingredients -->
            <div class="recipe-section">
                <h3 class="section-title">Ingredients</h3>
                <ul class="ingredients-list">
                    @foreach (var ingredient in draft.Recipe.Ingredients)
                    {
                        <li class="ingredient-item">
                            <span class="ingredient-quantity">
                                @if (ingredient.Quantity > 0)
                                {
                                    @FormatQuantity(ingredient.Quantity)
                                    @ingredient.Unit
                                }
                            </span>
                            <span class="ingredient-name">@ingredient.Name</span>
                            @if (!string.IsNullOrEmpty(ingredient.Notes))
                            {
                                <span class="ingredient-notes">(@ingredient.Notes)</span>
                            }
                        </li>
                    }
                </ul>
            </div>

            <!-- Instructions -->
            <div class="recipe-section">
                <h3 class="section-title">Instructions</h3>
                <ol class="instructions-list">
                    @foreach (var instruction in draft.Recipe.Instructions)
                    {
                        <li class="instruction-item">@instruction</li>
                    }
                </ol>
            </div>

            <!-- Source Information -->
            @if (draft.Source != null)
            {
                <div class="recipe-section source-section">
                    <h3 class="section-title">Source</h3>
                    <div class="source-info">
                        <a href="@draft.Source.Url" target="_blank" rel="noopener noreferrer" class="source-link">
                            @(draft.Source.SiteName ?? new Uri(draft.Source.Url).Host)
                        </a>
                        @if (!string.IsNullOrEmpty(draft.Source.Author))
                        {
                            <span class="source-author">by @draft.Source.Author</span>
                        }
                        <span class="extraction-method">
                            Extracted via @draft.Source.ExtractionMethod
                        </span>
                    </div>
                </div>
            }
        </div>

        <!-- Validation & Actions -->
        <div class="sidebar">
            <!-- Discovery Candidates (if available) -->
            @if (searchCandidates != null && searchCandidates.Count > 0)
            {
                <div class="qg-card candidates-card qg-mb-16">
                    <div class="qg-section-header">
                        <h3 class="qg-section-title">Discovery Results</h3>
                    </div>
                    <CandidateList Candidates="@searchCandidates" 
                                   SelectedIndex="@selectedCandidateIndex" />
                    
                    @if (searchCandidates.Count > 1 && !isTerminalState)
                    {
                        <div class="try-different-section">
                            <p class="try-different-hint">
                                Not the right recipe? You can start a new search with different terms.
                            </p>
                            <button class="qg-btn qg-btn-outline qg-btn-sm" @onclick="TryDifferentCandidate">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="m21 21-4.3-4.3"/>
                                </svg>
                                <span>Search Again</span>
                            </button>
                        </div>
                    }
                </div>
            }
            
            <!-- Validation Report -->
            <div class="qg-card validation-card">
                <div class="qg-section-header">
                    <h3 class="qg-section-title">Validation</h3>
                </div>

                @if (draft.ValidationReport.IsValid)
                {
                    <div class="validation-success">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        <span>Recipe is valid!</span>
                    </div>
                }
                else
                {
                    <div class="validation-errors">
                        <h4>Errors</h4>
                        <ul>
                            @foreach (var error in draft.ValidationReport.Errors)
                            {
                                <li class="error-item">@error</li>
                            }
                        </ul>
                    </div>
                }

                @if (draft.ValidationReport.Warnings.Any())
                {
                    <div class="validation-warnings">
                        <h4>Warnings</h4>
                        <ul>
                            @foreach (var warning in draft.ValidationReport.Warnings)
                            {
                                <li class="warning-item">@warning</li>
                            }
                        </ul>
                    </div>
                }
            </div>

            <!-- Similarity Report -->
            @if (draft.SimilarityReport != null)
            {
                <div class="qg-card similarity-card">
                    <div class="qg-section-header">
                        <h3 class="qg-section-title">Content Similarity</h3>
                    </div>

                    <div class="similarity-content">
                        @* Policy Status Indicator *@
                        <div class="similarity-status @(draft.SimilarityReport.ViolatesPolicy ? "status-error" : HasHighSimilarity() ? "status-warning" : "status-ok")">
                            @if (draft.SimilarityReport.ViolatesPolicy)
                            {
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="15" y1="9" x2="9" y2="15"/>
                                    <line x1="9" y1="9" x2="15" y2="15"/>
                                </svg>
                                <span>Policy Violation</span>
                            }
                            else if (HasHighSimilarity())
                            {
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                    <line x1="12" y1="9" x2="12" y2="13"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                                <span>Moderate Similarity</span>
                            }
                            else
                            {
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                <span>Content OK</span>
                            }
                        </div>

                        @* Similarity Metrics *@
                        <div class="similarity-metrics">
                            <div class="metric-item">
                                <span class="metric-label">Token Overlap</span>
                                <span class="metric-value @GetOverlapClass()">
                                    @draft.SimilarityReport.MaxContiguousTokenOverlap tokens
                                </span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">N-gram Similarity</span>
                                <span class="metric-value @GetSimilarityClass()">
                                    @(draft.SimilarityReport.MaxNgramSimilarity.ToString("P0"))
                                </span>
                            </div>
                        </div>

                        @* Details *@
                        @if (!string.IsNullOrEmpty(draft.SimilarityReport.Details))
                        {
                            <div class="similarity-details">
                                <details>
                                    <summary>View Details</summary>
                                    <p>@draft.SimilarityReport.Details</p>
                                </details>
                            </div>
                        }

                        @* Repair Outcome Indicator *@
                        @if (repairAttempted)
                        {
                            <div class="repair-outcome @(repairSuccessful ? "repair-success" : "repair-failed")">
                                @if (repairSuccessful)
                                {
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                    <span>Content was automatically rephrased</span>
                                }
                                else
                                {
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="12" y1="8" x2="12" y2="12"/>
                                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                    <span>Auto-repair attempted but similarity still high</span>
                                }
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Actions -->
            <div class="qg-card actions-card">
                <div class="qg-section-header">
                    <h3 class="qg-section-title">Actions</h3>
                </div>

                @* Terminal State Indicator *@
                @if (isTerminalState && !string.IsNullOrEmpty(taskStatus))
                {
                    <div class="terminal-state-indicator @GetTerminalStateClass()">
                        @GetTerminalStateIcon()
                        <span>@GetTerminalStateMessage()</span>
                    </div>
                }

                @* Success Message with Recipe Link *@
                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="success-message">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        <div class="success-content">
                            <span>@successMessage</span>
                            @if (!string.IsNullOrEmpty(committedRecipeId))
                            {
                                <a href="/recipes/@committedRecipeId" class="recipe-link">
                                    View Recipe ?
                                </a>
                            }
                        </div>
                    </div>
                }

                @* Error Message *@
                @if (!string.IsNullOrEmpty(errorMessage) && !isLoading)
                {
                    <div class="error-message">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span>@errorMessage</span>
                    </div>
                }

                <div class="action-buttons">
                    <button class="qg-btn qg-btn-primary qg-btn-lg" 
                            @onclick="CommitRecipe"
                            disabled="@(!CanCommit)">
                        @if (isCommitting)
                        {
                            <span class="loading-spinner"></span>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span>Add to Cookbook</span>
                        }
                    </button>
                    
                    @* Show blocked reason if similarity prevents commit *@
                    @if (SimilarityBlocksCommit())
                    {
                        <div class="commit-blocked-notice">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <span>Cannot commit: content similarity too high</span>
                        </div>
                        
                        <button class="qg-btn qg-btn-warning qg-btn-lg" 
                                @onclick="RepairContent"
                                disabled="@(isRepairing || isTerminalState)">
                            @if (isRepairing)
                            {
                                <span class="loading-spinner"></span>
                                <span>Repairing...</span>
                            }
                            else
                            {
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                                </svg>
                                <span>Repair Text</span>
                            }
                        </button>
                        <p class="repair-hint">Uses AI to paraphrase high-similarity content</p>
                    }

                    <button class="qg-btn qg-btn-accent" 
                            @onclick="StartNormalize"
                            disabled="@(isCommitting || isTerminalState || isNormalizing)">
                        @if (isNormalizing)
                        {
                            <span class="loading-spinner"></span>
                            <span>Normalizing...</span>
                        }
                        else
                        {
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            <span>Normalize Recipe</span>
                        }
                    </button>

                    <button class="qg-btn qg-btn-secondary" 
                            @onclick="ShowRejectDialog"
                            disabled="@(isCommitting || isTerminalState)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                        <span>Reject</span>
                    </button>

                    <button class="qg-btn qg-btn-outline" @onclick="NavigateToIngest">
                        <span>Import Another</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showRejectDialog)
{
    <div class="dialog-overlay" @onclick="HideRejectDialog">
        <div class="dialog" @onclick:stopPropagation>
            <h3>Reject Recipe</h3>
            <p>Are you sure you want to reject this recipe? It will not be added to your cookbook.</p>
            <div class="form-group">
                <label class="qg-label">Reason (optional)</label>
                <textarea class="qg-input" @bind="rejectReason" rows="3" placeholder="Why are you rejecting this recipe?"></textarea>
            </div>
            <div class="dialog-actions">
                <button class="qg-btn qg-btn-secondary" @onclick="HideRejectDialog">Cancel</button>
                <button class="qg-btn qg-btn-danger" @onclick="RejectRecipe">Reject</button>
            </div>
        </div>
    </div>
}

@if (isTerminalState && !string.IsNullOrEmpty(successMessage))
{
    <div class="success-message">
        <p>@successMessage</p>
        @if (!string.IsNullOrEmpty(committedRecipeId))
        {
            <p><a class="qg-btn qg-btn-primary" href="/recipes/@committedRecipeId">View in Cookbook</a></p>
        }
    </div>
}
